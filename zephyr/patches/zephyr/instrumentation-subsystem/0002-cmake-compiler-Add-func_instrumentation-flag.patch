From f807f95cdf2dd57f69bff7caf9cbbe7a85f626e0 Mon Sep 17 00:00:00 2001
From: Kevin Townsend <kevin.townsend@linaro.org>
Date: Sun, 13 Nov 2022 23:27:00 +0100
Subject: [PATCH 2/7] cmake: compiler: Add func_instrumentation flag

Adds a new compiler flag to enable function instrumentation injection
at compile time for compilers that support it.

Adds support for this flag to GCC when `CONFIG_INSTRUMENTATION` is
enabled, setting the `-finstrument-functions` flag during compilation.

Signed-off-by: Kevin Townsend <kevin.townsend@linaro.org>
Signed-off-by: Gustavo Romero <gustavo.romero@linaro.org>
Signed-off-by: Maciej Sobkowski <msobkowski@antmicro.com>
---
 CMakeLists.txt                               | 4 ++++
 cmake/compiler/compiler_flags_template.cmake | 3 +++
 cmake/compiler/gcc/compiler_flags.cmake      | 5 +++++
 3 files changed, 12 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index e78acb19f11..d23251e8966 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -503,6 +503,10 @@ zephyr_compile_options($<$<COMPILE_LANGUAGE:CXX>:$<TARGET_PROPERTY:compiler,no_p
 zephyr_link_libraries_ifndef(CONFIG_NATIVE_LIBRARY
                              $<TARGET_PROPERTY:linker,no_position_independent>)
 
+# @Intent: Enable function instrumentation injection at compile time
+zephyr_compile_options($<$<COMPILE_LANGUAGE:C>:$<TARGET_PROPERTY:compiler,func_instrumentation>>)
+zephyr_compile_options($<$<COMPILE_LANGUAGE:CXX>:$<TARGET_PROPERTY:compiler,func_instrumentation>>)
+
 # Allow the user to inject options when calling cmake, e.g.
 # 'cmake -DEXTRA_CFLAGS="-Werror -Wno-deprecated-declarations" ..'
 include(cmake/extra_flags.cmake)
diff --git a/cmake/compiler/compiler_flags_template.cmake b/cmake/compiler/compiler_flags_template.cmake
index 6050c46d385..59c23d364a0 100644
--- a/cmake/compiler/compiler_flags_template.cmake
+++ b/cmake/compiler/compiler_flags_template.cmake
@@ -170,3 +170,6 @@ set_compiler_property(PROPERTY no_function_sections)
 
 # Compiler flag for not placing variables in their own sections:
 set_compiler_property(PROPERTY no_data_sections)
+
+# Compiler flag to enable function instrumentation
+set_compiler_property(PROPERTY func_instrumentation)
diff --git a/cmake/compiler/gcc/compiler_flags.cmake b/cmake/compiler/gcc/compiler_flags.cmake
index 31e464f173e..3b232a17d47 100644
--- a/cmake/compiler/gcc/compiler_flags.cmake
+++ b/cmake/compiler/gcc/compiler_flags.cmake
@@ -277,3 +277,8 @@ set_compiler_property(PROPERTY no_function_sections "-fno-function-sections")
 
 # Compiler flag for not placing variables in their own sections:
 set_compiler_property(PROPERTY no_data_sections "-fno-data-sections")
+
+# Compiler flag to enable function instrumentation
+if(CONFIG_INSTRUMENTATION)
+set_compiler_property(PROPERTY func_instrumentation -finstrument-functions)
+endif()
-- 
2.50.0

